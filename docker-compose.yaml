version: '3'

services:
  traefik:
    image: ${TRAEFIK_IMAGE}
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.websecure.forwardedheaders.trustedips=0.0.0.0/0"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - web

  rocketchat:
    image: ${ROCKETCHAT_IMAGE}
    environment:
      - MONGO_URL=mongodb://mongo:27017/rocketchat
      - MONGO_OPLOG_URL=mongodb://mongo:27017/local
      - ROOT_URL=http://${ROOT_URL}
      - PORT=3000
      - OVERWRITE_SETTING_Accounts_RegistrationForm=Disabled
      - OVERWRITE_SETTING_Log_Level=2
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.rocketchat.rule=Host(`${ROOT_URL}`)"
      - "traefik.http.services.rocketchat.loadbalancer.server.port=3000"
    networks:
      - web
    deploy:
      replicas: ${ROCKET_REPLICAS}
    depends_on:
      - mongo

  mongo:
    image: ${MONGO_IMAGE}
    volumes:
      - mongo-data:/data/db
    networks:
      - web

  mongo-init-replica:
    image: ${MONGO_IMAGE}
    command: "mongo --eval 'rs.initiate({_id: \"rs0\", members: [{_id: 0, host: \"localhost:27017\"}]})'"
    depends_on:
      - mongo
    networks:
      - web

networks:
  web:
    #external: true

volumes:
  mongo-data:
